1ï¸âƒ£ reactive çš„ä¾èµ–æ˜¯æ”¶é›†åœ¨å“ªï¼Ÿ

ä¸€å¥è¯ç­”æ¡ˆï¼š

æ”¶é›†åœ¨ target â†’ key â†’ dep(Set<effect>) è¿™å¥—ç»“æ„é‡Œï¼Œç”± WeakMap ç®¡ç†ã€‚

çœŸå®ç»“æ„ï¼ˆæºç æ€è·¯ï¼‰
const targetMap = new WeakMap()
// targetMap:
//   target (åŸå¯¹è±¡) â†’ depsMap

// depsMap:
//   key (å±æ€§å) â†’ dep

// dep:
//   Set<ReactiveEffect>

ä¾èµ–æ”¶é›†å‘ç”Ÿåœ¨ä»€ä¹ˆæ—¶å€™ï¼Ÿ

ğŸ‘‰ è®¿é—®å±æ€§æ—¶ï¼ˆgetï¼‰


state.count // è§¦å‘ Proxy.get

åº•å±‚ç­‰ä»·é€»è¾‘ï¼š
track(target, key)

è§¦å‘æ›´æ–°å‘ç”Ÿåœ¨ä»€ä¹ˆæ—¶å€™ï¼Ÿ

ğŸ‘‰ ä¿®æ”¹å±æ€§æ—¶ï¼ˆsetï¼‰
state.count++
åº•å±‚ç­‰ä»·é€»è¾‘ï¼š
trigger(target, key)

é¢è¯•ä¸€å¥è¯é«˜åˆ†å›ç­”

reactive çš„ä¾èµ–è¢«æ”¶é›†åœ¨ä¸€ä¸ª WeakMap â†’ Map â†’ Set ç»“æ„ä¸­ï¼Œ
ä»¥ã€Œå¯¹è±¡ + å±æ€§ã€ä¸ºç»´åº¦ç²¾ç¡®è®°å½•ä½¿ç”¨è¯¥å±æ€§çš„ effectï¼Œå®ç°ç»†ç²’åº¦æ›´æ–°ã€‚

â¸»

2ï¸âƒ£ ref ä¸ºä»€ä¹ˆå¿…é¡» .valueï¼Ÿ

æœ¬è´¨åŸå› ï¼š

å› ä¸º ref æ˜¯ä¸€ä¸ª å¯¹è±¡åŒ…è£…å™¨ï¼ŒçœŸæ­£çš„å€¼å­˜åœ¨ .value ä¸Šã€‚

ref çš„çœŸå®å½¢æ€
const count = ref(0)
ç­‰ä»·äºï¼š
const count = {
  value: 0
}
ä¸ºä»€ä¹ˆä¸ç›´æ¥è¿”å› primitiveï¼Ÿ

å› ä¸ºï¼š
	â€¢	JS åŸºæœ¬ç±»å‹ä¸å¯æ‹¦æˆª
	â€¢	Proxy ä¸èƒ½ä»£ç† primitive

ğŸ‘‰ æ‰€ä»¥ Vue ç”¨å¯¹è±¡åŒ…ä¸€å±‚ï¼Œè®© .value å¯è¢«æ‹¦æˆª

.value çš„ get / set
get value() {
  track(this, 'value')
  return _value
}

set value(newVal) {
  _value = newVal
  trigger(this, 'value')
}
é¢è¯•ä¸€å¥è¯é«˜åˆ†å›ç­”

ref å¿…é¡»é€šè¿‡ .value è®¿é—®ï¼Œæ˜¯å› ä¸º Vue éœ€è¦ç”¨å¯¹è±¡åŒ…è£¹åŸºæœ¬ç±»å‹ï¼Œ
æ‰èƒ½é€šè¿‡ getter/setter å®Œæˆä¾èµ–æ”¶é›†å’Œæ›´æ–°è§¦å‘ã€‚

â¸»

3ï¸âƒ£ ä¸ºä»€ä¹ˆæ¨¡æ¿é‡Œ ref ä¸ç”¨ .valueï¼Ÿ

ç­”æ¡ˆï¼š

å› ä¸º æ¨¡æ¿ç¼–è¯‘é˜¶æ®µè‡ªåŠ¨åšäº† ref è§£åŒ…ï¼ˆunrefï¼‰

ç¼–è¯‘å‰
{{ count }}
ç¼–è¯‘åï¼ˆæ¦‚å¿µç­‰ä»·ï¼‰
_ctx.count.value
// æˆ–
unref(_ctx.count)
å“ªäº›åœ°æ–¹ä¼šè‡ªåŠ¨è§£åŒ…ï¼Ÿ

âœ… æ¨¡æ¿ä¸­
	â€¢	æ’å€¼
	â€¢	æŒ‡ä»¤
	â€¢	äº‹ä»¶è¡¨è¾¾å¼

âŒ JS é€»è¾‘ä¸­
setup() {
  console.log(count)      // ref å¯¹è±¡
  console.log(count.value) // çœŸæ­£çš„å€¼
}
ä¸ºä»€ä¹ˆä¸åœ¨ JS ä¸­ä¹Ÿè‡ªåŠ¨è§£åŒ…ï¼Ÿ

å› ä¸ºä¼šé€ æˆï¼š
	â€¢	è¯­ä¹‰ä¸æ¸…
	â€¢	å˜é‡èµ‹å€¼æ­§ä¹‰
	â€¢	ç ´åå“åº”å¼å¼•ç”¨æœ¬èº«

é¢è¯•ä¸€å¥è¯é«˜åˆ†å›ç­”

æ¨¡æ¿ä¸­çš„ ref ä¼šè¢«ç¼–è¯‘å™¨è‡ªåŠ¨è§£åŒ…æˆ .valueï¼Œ
è€Œ JS ä¸­å¿…é¡»æ˜¾å¼è®¿é—® .valueï¼Œä»¥ä¿è¯è¯­ä¹‰æ¸…æ™°å’Œå“åº”å¼å¯æ§ã€‚

â¸»

4ï¸âƒ£ toRefs çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ

ä¸€å¥è¯æœ¬è´¨ï¼š

toRefs æ˜¯ æŠŠ reactive å¯¹è±¡çš„æ¯ä¸ªå±æ€§ï¼Œå˜æˆä¸€ä¸ªâ€œæŒ‡å‘åŸå±æ€§çš„ refâ€

æ²¡ç”¨ toRefs çš„å‘

const state = reactive({ count: 0 })
const { count } = state  // âŒ å¤±å»å“åº”å¼
ä½¿ç”¨ toRefs

const state = reactive({ count: 0 })
const { count } = toRefs(state) // âœ…

toRefs çš„æ ¸å¿ƒå®ç°æ€æƒ³
toRefs(obj) {
  const res = {}
  for (let key in obj) {
    res[key] = toRef(obj, key)
  }
  return res
}
toRef åšäº†ä»€ä¹ˆï¼Ÿ

{
  get value() {
    return obj[key]
  },
  set value(val) {
    obj[key] = val
  }
}
ğŸ‘‰ ä¸æ˜¯æ‹·è´å€¼ï¼Œè€Œæ˜¯â€œå±æ€§çº§å¼•ç”¨â€

é¢è¯•ä¸€å¥è¯é«˜åˆ†å›ç­”

toRefs çš„æœ¬è´¨æ˜¯ä¸º reactive å¯¹è±¡çš„æ¯ä¸ªå±æ€§åˆ›å»ºä¸€ä¸ª ref ä»£ç†ï¼Œ
è®©è§£æ„åçš„å˜é‡ä»ç„¶æŒ‡å‘åŸå§‹å“åº”å¼æ•°æ®ï¼Œé¿å…å“åº”å¼ä¸¢å¤±ã€‚

â¸»

ğŸ§  å››é—®ä¸€å›¾ï¼ˆç»ˆææ€»ç»“ï¼‰

reactive:
  Proxy + WeakMap â†’ Map â†’ Set

ref:
  Object wrapper + .value getter/setter

template ref:
  compiler è‡ªåŠ¨ unref

toRefs:
  reactive å±æ€§ â†’ property-level ref
  







